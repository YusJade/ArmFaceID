# ArmFaceID - 24/10/4 - è¿›åº¦æ—¥å¿—

## é‡æ„ï¼šä½¿ç”¨æ¨¡æ¿åˆ›å»ºä¸åŒæ¶ˆæ¯ç±»å‹çš„è§‚å¯Ÿè€…

### é‡æ„çš„èµ·å› å’Œç›®æ ‡

åŸå…ˆçš„æ¥å£æ²¡æœ‰è€ƒè™‘åˆ°å¼•å…¥æ•°æ®åº“æ¨¡å—åçš„æ‹“å±•æ€§ï¼Œè§‚å¯Ÿè€…çš„å›è°ƒå‡½æ•°åªæä¾›äº†`id:int64_t`è¿™ä¸€ç§è¡¨ç¤ºç”¨æˆ·`id`çš„å½¢å‚ï¼Œè§‚å¯Ÿè€…è¿˜éœ€è¦å†æ¬¡é€šè¿‡`id`æŸ¥è¯¢æ•°æ®åº“ä»¥è·å–å…·ä½“çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ›´æ— æ³•è·å–è¯¥æ¬¡æ£€æµ‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ—¶é—´ã€æ¥æºè®¾å¤‡ã€ç­‰ç­‰ï¼‰ã€‚

ç°åœ¨å°è¯•ä½¿ç”¨æ¨¡æ¿ç¼–ç¨‹ï¼Œåœ¨å…¼å®¹ç°æœ‰ä»£ç çš„åŒæ—¶ï¼Œä¸ºè§‚å¯Ÿè€…æä¾›è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹çš„åŠŸèƒ½ ~

**ä¸€äº›ç–‘æƒ‘ğŸ§ï¼š**
- é€šè¿‡ç±»å‹å‚æ•°ä¸ºè§‚å¯Ÿè€…è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹ã€‚
- ä¸€ä¸ªè¢«è§‚å¯Ÿè€…èƒ½å¦`attach`ä¸åŒæ¶ˆæ¯ç±»å‹çš„è§‚å¯Ÿè€…ï¼Ÿæ˜¯å¦æœ‰è¿™æ ·åšçš„å¿…è¦ï¼Ÿ

### é‡æ„å‰çš„ä»£ç ï¼š`FaceDetectorObserver` ä¸ `FaceDetector`
```cpp
namespace arm_face_id {
namespace interface {

class FaceDetectorObserver {
 public:
  static const int64_t kFaceNotDetected = -1;
  static const int64_t kFaceAlreadyExisted = -2;

  FaceDetectorObserver() = default;

  virtual void OnFaceDetected(cv::Mat img, vector<cv::Rect> faces) = 0;
  virtual void OnFaceRecognized(cv::Mat img, cv::Rect face, int64_t id) = 0;

  virtual void OnFaceRegistered(cv::Mat img, cv::Rect face, int64_t id) {}

 private:
};

class FaceDetector {
 public:
  FaceDetector() = default;

  inline void AddObserver(shared_ptr<FaceDetectorObserver> observer) {
    if (observer) {
      observers_.push_back(observer);
    }
  }

  inline void removeObserver(shared_ptr<FaceDetectorObserver> observer) {
    if (observer) {
      auto postion = std::find(observers_.begin(), observers_.end(), observer);
      if (postion != observers_.end()) {
        observers_.erase(postion);
      }
    }
  }

 protected:
  vector<shared_ptr<FaceDetectorObserver>> observers_;
};
```

### é‡æ„çš„é€‰æ‹©

<img src="./images/observer_refactor.png" width=70%/>

`FaceDetectorObserverConrete` å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œé€šè¿‡é™æ€ç±»å‹è½¬æ¢è·å¾—å…·ä½“ç±»å‹çš„æ¶ˆæ¯ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½æ‰‹åŠ¨ç¼–å†™ç±»å‹è½¬æ¢ã€‚

```cpp

// ç”±å®é™…çš„è§‚å¯Ÿè€…å®ç°å…·ä½“é€»è¾‘
virtual void FaceDetectorObserverConrete<MsgT>::OnNotify(MsgT* msg) = 0;

FaceDetectorObserverConrete<MsgT>::OnNotifyA(void* msg) {
  // é€šè¿‡ç¼–è¯‘æ—¶ç±»å‹è½¬æ¢ï¼Œå°† msg è½¬æ¢ä¸ºå¯¹åº”çš„æ¶ˆæ¯ç±»å‹
  auto msg_casted = std::static_cast<MsgT*>(msg);
  // æ‰§è¡Œå…·ä½“çš„å›è°ƒé€»è¾‘
  OnNotifyA(msg_casted);
}
```

**ä¸€äº›ç–‘æƒ‘ğŸ§ï¼š**
- å¦‚æ­¤è®¾è®¡ï¼Œä¸€ä¸ªè¢«è§‚å¯Ÿè€…å¯ä»¥å…³è”åˆ°ä¸åŒæ¶ˆæ¯ç±»å‹çš„è§‚å¯Ÿè€…ï¼ˆè‡³å°‘å¯ä»¥å¡è¿›è§‚å¯Ÿè€…çš„`vector`é‡Œï¼‰ï¼Œä½†åœ¨é€šçŸ¥è§‚å¯Ÿè€…æ—¶ï¼Œå¯èƒ½æ— æ³•é€šè¿‡ç¼–è¯‘æ—¶çš„ç±»å‹æ£€æŸ¥ğŸ˜Œã€‚
- æ‰€ä»¥ï¼Œæ˜¯å¦éœ€è¦å°†è¢«è§‚å¯Ÿè€…æ¨¡æ¿åŒ–ï¼Œæ¥ä¿è¯ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨ï¼Ÿ