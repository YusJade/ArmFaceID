# ArmFaceID-24/8/6-è¿›åº¦æ—¥å¿—

## è¿›åº¦æ€»ç»“
åœ¨ win æ„å»ºå®‰è£… Google çš„ grpc æ¡†æ¶ï¼Œä»¥å®ç°äººè„¸è¯†åˆ«ç»ˆç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡ã€‚åŒæ—¶å°†æ•´ä¸ªé¡¹ç›®æ‹†åˆ†æˆå¤šä¸ªå·¥ç¨‹ï¼Œç›®å‰æœ‰ `client` ã€`server` ã€`proto` ä¸‰ä¸ªæ¨¡å—ï¼Œåˆ©ç”¨ CMake è¿›è¡Œæ„å»ºã€‚ä»Šæ—¥çš„å¤§éƒ¨åˆ†å·¥å¤«éƒ½èŠ±è´¹åœ¨ç†è§£ CMake ä¸Šï¼Œè®¤è¯†åˆ° CMake ç¡®å®æ˜¯æ„å»ºå¤æ‚å·¥ç¨‹çš„å®ç”¨å·¥å…·ã€‚
## é—®é¢˜æ€»ç»“

### å¯¹ `gRpc` ä»¥åŠ `protobuf` çš„ç–‘æƒ‘

#### æ–¹æ³• `set_allocated_xx` çš„æ„ä¹‰ï¼Ÿ
å°†ä¸€ä¸ªå·²ç»åˆ†é…å¥½çš„å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªæ¶ˆæ¯å­—æ®µï¼Œé¿å…äº†é¢å¤–çš„å†…å­˜åˆ†é…å’Œæ‹·è´æ“ä½œã€‚è¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿å¯¹è±¡çš„æ‰€æœ‰æƒæ¸…æ™°ï¼Œå› ä¸ºå…¶å°†æŒ‡é’ˆçš„æ‰€æœ‰æƒè½¬ç§»äº†ã€‚åœ¨æ€§èƒ½å…³é”®çš„åº”ç”¨ä¸­ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜åˆ†é…å’Œæ‹·è´çš„å¼€é”€ã€‚

`set_allocated_xx` æ–¹æ³•çš„ä½œç”¨ï¼š
- **ç›´æ¥ç®¡ç†å†…å­˜**ï¼šå…è®¸ç›´æ¥å°†ä¸€ä¸ªæŒ‡é’ˆèµ‹å€¼ç»™æ¶ˆæ¯å­—æ®µï¼Œè¡¨ç¤ºæ¶ˆæ¯å¯¹è±¡ç°åœ¨æ‹¥æœ‰äº†è¯¥æŒ‡é’ˆçš„æ‰€æœ‰æƒã€‚
- **é¿å…æ‹·è´**ï¼šé¿å…äº†å°†æ•°æ®ä»ä¸€ä¸ªå¯¹è±¡æ‹·è´åˆ°å¦ä¸€ä¸ªå¯¹è±¡çš„å¼€é”€ã€‚
- **å†…å­˜ç®¡ç†çš„è´£ä»»è½¬ç§»**ï¼šåœ¨è°ƒç”¨ `set_allocated_xx` æ–¹æ³•åï¼Œæ¶ˆæ¯å¯¹è±¡ä¼šè´Ÿè´£é‡Šæ”¾è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ã€‚

##### ä½¿ç”¨ç¤ºä¾‹

å‡è®¾æœ‰ä¸€ä¸ª `Person` æ¶ˆæ¯ç±»å‹ï¼Œå®ƒåŒ…å«ä¸€ä¸ª `Address` å­æ¶ˆæ¯ç±»å‹ï¼š

```proto
message Address {
  string street = 1;
  string city = 2;
}

message Person {
  string name = 1;
  Address address = 2;
}
```

```cpp
#include "person.pb.h"
#include <iostream>

int main() {
    // åˆ›å»ºä¸€ä¸ª Address å¯¹è±¡
    Address* address = new Address();
    address->set_street("123 Main St");
    address->set_city("Hometown");

    // åˆ›å»ºä¸€ä¸ª Person å¯¹è±¡
    Person person;
    
    // ä½¿ç”¨ set_allocated_address å°†åœ°å€å¯¹è±¡èµ‹å€¼ç»™ person
    person.set_allocated_address(address);

    // æ­¤æ—¶ person å¯¹è±¡æ‹¥æœ‰ address çš„æ‰€æœ‰æƒï¼Œä¸éœ€è¦å†æ‰‹åŠ¨åˆ é™¤ address
    std::cout << "Name: " << person.name() << std::endl;  // ç©ºå­—ç¬¦ä¸²ï¼Œå› ä¸ºæœªè®¾ç½®
    std::cout << "Street: " << person.address().street() << std::endl;
    std::cout << "City: " << person.address().city() << std::endl;

    // å½“ person è¢«é”€æ¯æ—¶ï¼Œaddress çš„å†…å­˜ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾
    return 0;
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`address` æŒ‡é’ˆè¢«èµ‹å€¼ç»™ `person` çš„ `address` å­—æ®µã€‚æ­¤æ—¶ï¼Œ`person` å¯¹è±¡æ‹¥æœ‰äº† `address` æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œå½“ `person` å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨é‡Šæ”¾ `address` æŒ‡å‘çš„å†…å­˜ã€‚

##### æ³¨æ„äº‹é¡¹

- **æ‰€æœ‰æƒè½¬ç§»**ï¼šè°ƒç”¨ `set_allocated_xx` åï¼Œè°ƒç”¨è€…ä¸åº”å†ä½¿ç”¨æˆ–é‡Šæ”¾è¯¥æŒ‡é’ˆï¼Œå› ä¸ºæ‰€æœ‰æƒå·²ç»è½¬ç§»ç»™æ¶ˆæ¯å¯¹è±¡ã€‚
- **ç¡®ä¿æŒ‡é’ˆçš„å”¯ä¸€æ€§**ï¼šç¡®ä¿åœ¨è°ƒç”¨ `set_allocated_xx` æ–¹æ³•å‰ï¼Œè¯¥æŒ‡é’ˆæœªè¢«å…¶ä»–å¯¹è±¡æ‹¥æœ‰ï¼Œä»¥é¿å…é‡å¤é‡Šæ”¾å¯¼è‡´çš„å´©æºƒæˆ–æœªå®šä¹‰è¡Œä¸ºã€‚

#### `grpc`ã€`grpcpp`ã€`grpc++` ä¸‰ç§ API çš„æ„ä¹‰ï¼Ÿ
åœ¨ä½¿ç”¨ gRPC çš„å¤´æ–‡ä»¶æ—¶ï¼Œå‘ç°å…¶åˆ†ä¸ºäº†ä¸‰ä¸ªç›®å½•ï¼Œå…¶å®å®ƒä»¬çš„ä½œç”¨åœ¨å¯¹åº”çš„å¤´æ–‡ä»¶ä¸­æœ‰ç›¸å…³çš„è¯´æ˜ï¼š
```c++
#ifndef GRPC_GRPC_H
#define GRPC_GRPC_H
// ...
/*! \mainpage GRPC Core
 *
 * The GRPC Core library is a low-level library designed to be wrapped by higher
 * level libraries. The top-level API is provided in grpc.h. Security related
 * functionality lives in grpc_security.h.
 */
// ...
#endif /* GRPC_GRPC_H */
```
```c++
/// \mainpage gRPC C++ API
///
/// The gRPC C++ API mainly consists of the following classes:
/// <br>
/// - grpc::Channel, which represents the connection to an endpoint. See [the
/// gRPC Concepts page](https://grpc.io/docs/what-is-grpc/core-concepts) for
/// more details. Channels are created by the factory function
/// grpc::CreateChannel.
///
/// - grpc::CompletionQueue, the producer-consumer queue used for all
/// asynchronous communication with the gRPC runtime.
///
/// - grpc::ClientContext and grpc::ServerContext, where optional configuration
/// for an RPC can be set, such as setting custom metadata to be conveyed to the
/// peer, compression settings, authentication, etc.
///
/// - grpc::Server, representing a gRPC server, created by grpc::ServerBuilder.
///
/// Streaming calls are handled with the streaming classes in
/// \ref sync_stream.h and
/// \ref async_stream.h.
///
/// Refer to the
/// [examples](https://github.com/grpc/grpc/blob/master/examples/cpp)
/// for code putting these pieces into play.

#ifndef GRPCPP_GRPCPP_H
#define GRPCPP_GRPCPP_H
// ...
#endif // GRPCPP_GRPCPP_H
```

```c++
// DEPRECATED: The headers in include/grpc++ are deprecated. Please include the
// headers in include/grpcpp instead. This header exists only for backwards
// compatibility.

#ifndef GRPCXX_GRPCXX_H
#define GRPCXX_GRPCXX_H

#include <grpcpp/grpcpp.h>

#endif  // GRPCXX_GRPCXX_H
```

### å¯¹ `CMake` çš„ç–‘æƒ‘

#### `gRPCConfig.cmake` ä¼¼ä¹æ²¡æœ‰æä¾› `gRPC_INCLUDE_DIRS`ï¼Ÿ
æˆ‘é€‰æ‹©ä¿®æ”¹ `gRPCConfig.cmake` ...
```cmake
# added by Yusjade
get_target_property(gRPC_INCLUDE_DIRS 
gRPC::grpc INTERFACE_INCLUDE_DIRECTORIES)
```

### ç¼–è¯‘ç¬¬ä¸‰æ–¹åº“çš„`mingw`ç‰ˆæœ¬ä¸åŒï¼Œå¯¼è‡´æ— æ³•å®šä½ç¨‹åºè¾“å…¥ç‚¹

<img height=30% src="./images/error.png" />

åŸå› æ—¶æˆ‘ç¼–è¯‘ opencv æ—¶ä½¿ç”¨çš„ mingw æ˜¯ Qt é™„å¸¦å®‰è£…çš„ç‰ˆæœ¬ï¼Œä¸æˆ‘ç¼–è¯‘ä½¿ç”¨ opencv çš„ç¨‹åºæ—¶ï¼Œä½¿ç”¨çš„ mingw ç‰ˆæœ¬ä¸åŒï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€è‡´çš„ mingw é‡æ–°ç¼–è¯‘å®‰è£… opencv å³å¯è§£å†³é—®é¢˜ã€‚

> ğŸ¤–ï¼šä½¿ç”¨ç”±ä¸åŒç‰ˆæœ¬çš„ MinGW ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹åº“å¯èƒ½ä¼šå¼•å‘ä¸€äº›é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°æ— æ³•æ‰¾åˆ°ç¨‹åºè¾“å…¥ç‚¹ï¼ˆentry pointï¼‰çš„é—®é¢˜ã€‚è¿™ä¸»è¦æ˜¯ç”±äºä¸åŒç‰ˆæœ¬çš„ MinGW å¯èƒ½ä¼šä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ GCC ç¼–è¯‘å™¨å’Œä¸åŒçš„è¿è¡Œæ—¶åº“ï¼Œè¿™äº›å·®å¼‚ä¼šå¯¼è‡´å…¼å®¹æ€§é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢éœ€è¦æ³¨æ„ï¼š
>1. **ABIï¼ˆApplication Binary Interfaceï¼‰ä¸å…¼å®¹**ï¼šä¸åŒç‰ˆæœ¬çš„ GCC ç¼–è¯‘å™¨å¯èƒ½ä¼šæœ‰ä¸åŒçš„ ABIï¼Œè¿™æ„å‘³ç€å®ƒä»¬ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½æ— æ³•ç›¸äº’å…¼å®¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæ‰¾ä¸åˆ°æ­£ç¡®çš„å‡½æ•°æˆ–æ•°æ®ç»“æ„ï¼Œå¯¼è‡´æ— æ³•æ‰¾åˆ°ç¨‹åºè¾“å…¥ç‚¹çš„é—®é¢˜ã€‚
>2. **è¿è¡Œæ—¶åº“ç‰ˆæœ¬ä¸åŒ¹é…**ï¼šä¸åŒç‰ˆæœ¬çš„ MinGW å¯èƒ½ä¼šå¸¦æœ‰ä¸åŒç‰ˆæœ¬çš„è¿è¡Œæ—¶åº“ï¼ˆå¦‚ `libgcc`, `libstdc++` ç­‰ï¼‰ã€‚å¦‚æœä½ çš„ç¨‹åºä¾èµ–äºè¿™äº›åº“ï¼Œå¹¶ä¸”è¿™äº›åº“ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œé‚£ä¹ˆåœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°æ‰¾ä¸åˆ°ç¬¦å·æˆ–ç¨‹åºè¾“å…¥ç‚¹çš„é—®é¢˜ã€‚
>3. **åŠ¨æ€é“¾æ¥åº“å†²çª**ï¼šå¦‚æœä½ çš„ç¨‹åºä½¿ç”¨åŠ¨æ€é“¾æ¥åº“ï¼Œå¹¶ä¸”è¿™äº›åº“ç”±ä¸åŒç‰ˆæœ¬çš„ MinGW ç¼–è¯‘ï¼Œé‚£ä¹ˆè¿™äº›åº“ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨ç¬¦å·å†²çªï¼Œå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

> ğŸ¤–ï¼š**è§£å†³æ–¹æ³•**
>1. **ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ MinGW ç¼–è¯‘æ‰€æœ‰åº“**ï¼šä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¡®ä¿æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“å’Œä½ çš„ç¨‹åºéƒ½ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ MinGW ç¼–è¯‘ã€‚è¿™å¯ä»¥ç¡®ä¿ ABI å’Œè¿è¡Œæ—¶åº“çš„ä¸€è‡´æ€§ã€‚
>2. **é™æ€é“¾æ¥**ï¼šå¦‚æœå¯èƒ½ï¼Œå°½é‡ä½¿ç”¨é™æ€é“¾æ¥åº“è€Œä¸æ˜¯åŠ¨æ€é“¾æ¥åº“ã€‚é™æ€é“¾æ¥å¯ä»¥é¿å…è¿è¡Œæ—¶çš„åº“ç‰ˆæœ¬å†²çªé—®é¢˜ã€‚ä½ å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ `-static` é€‰é¡¹æ¥å®ç°é™æ€é“¾æ¥ã€‚
>3. **æ£€æŸ¥å’ŒåŒ¹é…è¿è¡Œæ—¶åº“**ï¼šç¡®ä¿åœ¨è¿è¡Œæ—¶ï¼Œæ‰€æœ‰éœ€è¦çš„åŠ¨æ€é“¾æ¥åº“éƒ½æ¥è‡ªåŒä¸€ä¸ªç‰ˆæœ¬çš„ MinGWã€‚è¿™æ„å‘³ç€ä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨ç®¡ç†è¿™äº›åº“æ–‡ä»¶ï¼Œç¡®ä¿å®ƒä»¬ç‰ˆæœ¬åŒ¹é…å¹¶ä¸”åœ¨ç³»ç»Ÿ `PATH` æˆ–ç¨‹åºç›®å½•ä¸­ã€‚
>4. **ä½¿ç”¨å®¹å™¨æˆ–è™šæ‹Ÿç¯å¢ƒ**ï¼šå¦‚æœä½ çš„ç¨‹åºéœ€è¦åœ¨ä¸åŒçš„ç¯å¢ƒä¸­è¿è¡Œï¼Œè€ƒè™‘ä½¿ç”¨å®¹å™¨æŠ€æœ¯ï¼ˆå¦‚ Dockerï¼‰æˆ–è™šæ‹Ÿç¯å¢ƒæ¥ç¡®ä¿æ‰€æœ‰ä¾èµ–åº“çš„ä¸€è‡´æ€§ã€‚è¿™å¯ä»¥éš”ç¦»ä¸åŒç‰ˆæœ¬çš„åº“ï¼Œé¿å…å†²çªã€‚

### é€šè¿‡ CMake ç¼–è¯‘ç”Ÿæˆ `proto.cc/.h` æ–‡ä»¶

### é€šè¿‡ CMake ç»„ç»‡å¤šä¸ªå­å·¥ç¨‹çš„æ„å»º
ä½¿ç”¨ `add_subdirectory` å¯ä»¥ä¸ºå·¥ç¨‹æ·»åŠ å­å·¥ç¨‹ç›®å½•ï¼Œè¿™æ · CMake ä¼šè¿›å…¥ç›®å½•ä¸­æ ¹æ®å…¶ä¸­çš„ `CMakeLists.txt` å¯¹å­å·¥ç¨‹è¿›è¡Œæ„å»ºã€‚
```cmake
add_subdirectory(
  # å­å·¥ç¨‹ç›®å½•å
)
```
å¦‚æœå­å·¥ç¨‹ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚ç¼–è¯‘ `server` æ—¶éœ€è¦é“¾æ¥ `proto` ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨ `server` çš„ `CMakeLists.txt`  ä¸­æ·»åŠ é“¾æ¥ç›®æ ‡ï¼ˆ`target`ï¼‰
```cmake
# é“¾æ¥ gRPC ã€ opencv ã€å’Œå­å·¥ç¨‹ proto
target_link_libraries(server
    PUBLIC
        face_proto
        ${OpenCV_LIBS}
)
```